#!/usr/bin/env bash
set -euo pipefail

if [ $# -ne 1 ]; then
  echo "Usage: $0 <scope>   (e.g. $0 @tluyben)"
  exit 1
fi

SCOPE="$1"
# ensure it starts with "@"
if [[ "${SCOPE}" != @* ]]; then
  SCOPE="@${SCOPE}"
fi

# 1. Increment patch version in the actual repository
echo "ðŸ“ˆ Incrementing patch version in package.json..."
OLD_VERSION=$(node -p "require('./package.json').version")
node -e "
  const fs = require('fs');
  const pkg = require('./package.json');
  
  // Increment patch version
  const versionParts = pkg.version.split('.');
  versionParts[2] = parseInt(versionParts[2]) + 1;
  pkg.version = versionParts.join('.');
  
  console.log('  â†’ Version updated from ' + '${OLD_VERSION}' + ' to ' + pkg.version);
  
  fs.writeFileSync(
    'package.json',
    JSON.stringify(pkg, null, 2) + '\\n'
  );
"

NEW_VERSION=$(node -p "require('./package.json').version")

# 2. Commit and push the version bump
echo "ðŸ“ Committing version bump..."
git add package.json
git commit -m "bump patch version to ${NEW_VERSION}"
git push

# 3. Build the project
echo "ðŸ”§ Building project..."
npm run build

# 4. Pack
echo "ðŸ”¨ Running npm packâ€¦"
TARBALL=$(npm pack | tail -n1)
echo "  â†’ created ${TARBALL}"

# 5. Unpack
TMPDIR=$(mktemp -d)
echo "ðŸ“‚ Extracting to ${TMPDIR}"
tar -xzf "${TARBALL}" -C "${TMPDIR}"

PKGDIR="${TMPDIR}/package"
pushd "${PKGDIR}" > /dev/null

# 6. Patch package.json with new scope
OLD_NAME=$(node -p "require('./package.json').name")
# strip any existing scope (things before the slash)
PKG_BASE="${OLD_NAME##*/}"
NEW_NAME="${SCOPE}/${PKG_BASE}"

echo "âœï¸  Renaming package from \"${OLD_NAME}\" to \"${NEW_NAME}\""
node -e "
  const fs = require('fs');
  const pkg = require('./package.json');
  pkg.name = '${NEW_NAME}';
  
  fs.writeFileSync(
    'package.json',
    JSON.stringify(pkg, null, 2) + '\\n'
  );
"

# 7. Publish
echo "ðŸš€ Publishing as ${NEW_NAME} v${NEW_VERSION}..."
npm publish --access public

popd > /dev/null

# 8. Cleanup
echo "ðŸ§¹ Cleaning upâ€¦"
rm -rf "${TMPDIR}" "${TARBALL}"

echo "ðŸŽ‰ Published ${NEW_NAME} v${NEW_VERSION}"
