#!/usr/bin/env bash
set -euo pipefail

if [ $# -ne 1 ]; then
  echo "Usage: $0 <scope>   (e.g. $0 @tluyben)"
  exit 1
fi

SCOPE="$1"
# ensure it starts with "@"
if [[ "${SCOPE}" != @* ]]; then
  SCOPE="@${SCOPE}"
fi

# 1. pack
echo "🔨 Running npm pack…"
TARBALL=$(npm pack | tail -n1)
echo "  → created ${TARBALL}"

# 2. unpack
TMPDIR=$(mktemp -d)
echo "📂 Extracting to ${TMPDIR}"
tar -xzf "${TARBALL}" -C "${TMPDIR}"

PKGDIR="${TMPDIR}/package"
pushd "${PKGDIR}" > /dev/null

# 3. patch package.json
OLD_NAME=$(node -p "require('./package.json').name")
# strip any existing scope (things before the slash)
PKG_BASE="${OLD_NAME##*/}"
NEW_NAME="${SCOPE}/${PKG_BASE}"

echo "✏️  Renaming package from \"${OLD_NAME}\" to \"${NEW_NAME}\""
node -e "
  const fs = require('fs');
  const pkg = require('./package.json');
  pkg.name = '${NEW_NAME}';
  fs.writeFileSync(
    'package.json',
    JSON.stringify(pkg, null, 2) + '\\n'
  );
"

# 4. publish
echo "🚀 Publishing as ${NEW_NAME}..."
npm publish --access public

popd > /dev/null

# 5. cleanup
echo "🧹 Cleaning up…"
rm -rf "${TMPDIR}" "${TARBALL}"

echo "🎉 Published ${NEW_NAME}"
