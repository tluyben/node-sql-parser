#!/usr/bin/env bash
set -euo pipefail

if [ $# -ne 1 ]; then
  echo "Usage: $0 <scope>   (e.g. $0 @tluyben)"
  exit 1
fi

SCOPE="$1"
# ensure it starts with "@"
if [[ "${SCOPE}" != @* ]]; then
  SCOPE="@${SCOPE}"
fi

# 1. pack
echo "ðŸ”¨ Running npm packâ€¦"
TARBALL=$(npm pack | tail -n1)
echo "  â†’ created ${TARBALL}"

# 2. unpack
TMPDIR=$(mktemp -d)
echo "ðŸ“‚ Extracting to ${TMPDIR}"
tar -xzf "${TARBALL}" -C "${TMPDIR}"

PKGDIR="${TMPDIR}/package"
pushd "${PKGDIR}" > /dev/null

# 3. patch package.json
OLD_NAME=$(node -p "require('./package.json').name")
# strip any existing scope (things before the slash)
PKG_BASE="${OLD_NAME##*/}"
NEW_NAME="${SCOPE}/${PKG_BASE}"

echo "âœï¸  Renaming package from \"${OLD_NAME}\" to \"${NEW_NAME}\""
echo "ðŸ“ˆ Incrementing patch version..."
node -e "
  const fs = require('fs');
  const pkg = require('./package.json');
  pkg.name = '${NEW_NAME}';
  
  // Increment patch version
  const versionParts = pkg.version.split('.');
  versionParts[2] = parseInt(versionParts[2]) + 1;
  pkg.version = versionParts.join('.');
  
  console.log('  â†’ Version updated to ' + pkg.version);
  
  fs.writeFileSync(
    'package.json',
    JSON.stringify(pkg, null, 2) + '\\n'
  );
"

# 4. publish
echo "ðŸš€ Publishing as ${NEW_NAME}..."
npm publish --access public

popd > /dev/null

# 5. cleanup
echo "ðŸ§¹ Cleaning upâ€¦"
rm -rf "${TMPDIR}" "${TARBALL}"

echo "ðŸŽ‰ Published ${NEW_NAME}"
